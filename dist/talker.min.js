!function(e,t){"function"==typeof define&&define.amd?define([],t):e.Talker=t()}(this,function(){var e="application/x-talkerjs-v1+json",t=function(e,t,s){this.remoteWindow=e,this.remoteOrigin=t,this.Promise=s||Promise,this.timeout=3e3,this.handshaken=!1,this.handshake=new this.Promise(function(e){this.resolveHandshake=e}.bind(this)),this._id=0,this._queue=[],this._sent={};var i=this;return window.addEventListener("message",function(e){i._receiveMessage(e)},!1),this._sendHandshake(),this};return t.prototype.send=function(e,s,i){var n=new t.OutgoingMessage(this,e,s,i),o=this;return this.Promise.race([new this.Promise(function(e,t){o._sent[n.id]=e,o._queue.push(n),o._flushQueue()}),new this.Promise(function(e,t){setTimeout(t.bind(void 0,new Error("timeout")),o.timeout)})])},t.prototype._receiveMessage=function(e){var t,s;try{t=JSON.parse(e.data)}catch(e){t={}}return!!this._isSafeMessage(e.source,e.origin,t.type)&&(s=t.handshake||t.handshakeConfirmation,s?this._handleHandshake(t):this._handleMessage(t))},t.prototype._isSafeMessage=function(t,s,i){var n,o,a;return n=t===this.remoteWindow,o="*"===this.remoteOrigin||s===this.remoteOrigin,a=i===e,n&&o&&a},t.prototype._handleHandshake=function(e){e.handshake&&this._sendHandshake(this.handshaken),this.handshaken=!0,this.resolveHandshake(!0),this._flushQueue()},t.prototype._handleMessage=function(e){var s=new t.IncomingMessage(this,e.namespace,e.data,e.id),i=e.responseToId;return i?this._respondToMessage(i,s):this._broadcastMessage(s)},t.prototype._respondToMessage=function(e,t){this._sent[e]&&(this._sent[e](t),delete this._sent[e])},t.prototype._broadcastMessage=function(e){this.onMessage&&this.onMessage.call(this,e)},t.prototype._sendHandshake=function(t){var s={type:e};s[t?"handshakeConfirmation":"handshake"]=!0,this._postMessage(s)},t.prototype._nextId=function(){return this._id+=1},t.prototype._postMessage=function(e){this.remoteWindow&&this.remoteOrigin&&this.remoteWindow.postMessage(JSON.stringify(e),this.remoteOrigin)},t.prototype._flushQueue=function(){if(this.handshaken){var e=this._queue.shift();if(!e)return this._queue;if(this._postMessage(e),this._queue.length>0)return this._flushQueue()}return this._queue},t.Message=function(t,s,i){return this.talker=t,this.namespace=s,this.data=i,this.type=e,this},t.OutgoingMessage=function(e,s,i,n){t.Message.call(this,e,s,i),this.responseToId=n||null,this.id=this.talker._nextId()},t.OutgoingMessage.prototype=Object.create(t.Message.prototype),t.OutgoingMessage.prototype.constructor=t.Message,t.OutgoingMessage.prototype.toJSON=function(){return{id:this.id,responseToId:this.responseToId,namespace:this.namespace,data:this.data,type:this.type}},t.IncomingMessage=function(e,s,i,n){t.Message.call(this,e,s,i),this.id=n},t.IncomingMessage.prototype=Object.create(t.Message.prototype),t.IncomingMessage.prototype.constructor=t.Message,t.IncomingMessage.prototype.respond=function(e){return this.talker.send(null,e,this.id)},t});